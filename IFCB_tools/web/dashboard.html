<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link type="text/css" href="css/smoothness/jquery-ui-1.8.14.custom.css" rel="Stylesheet" />
<link type="text/css" href="dashboard.css" rel="Stylesheet"/>
<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.14.custom.min.js"></script>
<script type="text/javascript" src="js/ifcb-util.js"></script>
<script type="text/javascript">
function render(entry,width,tag) {
    $.ajax({
        url: entry['pid']+'/head.json',
        type: 'GET',
        datatype: 'json',
        success: function(r, status) {
            var instrument = r['instrument']
            var time = r['time'];
            var temp = Math.round(r['temperature'])+'&deg;C';
            $('#'+tag).append('<br>IFCB#'+r['instrument']+' @ '+r['time']+' '+temp);
        }
    });
    $.ajax({
        url: '../mosaic.py?format=json&pid='+entry['pid'],
        type: 'GET',
        datatype: 'json',
        success: function(r, status) {
            var scale = width / r['width'];
            var canvas = $('#'+tag+'c')[0];
            var ctx = undefined;
            if(canvas.getContext == undefined) {
                alert('This browser does not support canvas.');
            } else {
                ctx = canvas.getContext('2d');
            }
            ctx.fillStyle = '#999'; // gray
            ctx.fillRect(0,0,r['width'] * scale,r['height'] * scale);
            var tiles = r['tiles']
            for(i = 0; i < tiles.length; i++) {
                var tile = tiles[i];
                var x = tile['x'] * scale;
                var y = tile['y'] * scale;
                var w = tile['width'] * scale;
                var h = tile['height'] * scale;
                var pid = tile['pid'];
                ctx.strokeRect(x+1,y+1,w-2,h-2);
                $('#'+tag+'c').bind('click',{left:x, top:y, right:x+w, bottom:y+h, pid:pid},function(event) {
                    mx = event.pageX - $(this).offset().left;
                    my = event.pageY - $(this).offset().top;
                    if(mx >= event.data.left && mx <= event.data.right &&
                       my >= event.data.top && my <= event.data.bottom) {
                        location.href = event.data.pid+'.html';
                    }
                });
                var img = new Image();
                $(img).bind('load', {x:x, y:y, w:w, h:h}, function(event) {
                    ctx.drawImage(this, event.data.x, event.data.y, event.data.w, event.data.h);
                });
                img.src = tile['pid'] + '.jpg';
            }
        }
    });
}
$(document).ready(function() {
    date = query_param('date','now');
    $.ajax({
        url : '../rss.py?format=json&date='+date,
        type : 'GET',
        datatype : 'json',
        success : function(r, status) {
            render(r[0],800,'top')
            for (index = 1; index < 4; index++) {
		render(r[index],264,'s'+index);
            }
         }
    });
});
</script>
</head>
<body>
  <table width="800px">
    <tr>
      <td colspan="3" id="top">
	<canvas id="topc" width="800" height="450"/>
      </td>
    </tr>
    <tr>
      <td width="33%" id="s1">
	<canvas width="264" height="149" id="s1c"/>
      </td>
      <td width="33%" id="s2">
	<canvas width="264" height="149" id="s2c"/>
      </td>
      <td width="33%" id="s3">
	<canvas width="264" height="149" id="s3c"/>
      </td>
  </table>
  <div id="status"></div>
</body>
</html>
